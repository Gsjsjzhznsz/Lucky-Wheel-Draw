<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>抽奖转盘</title>
<style>
  :root{
    --bg1:#081226; --bg2:#0e2a3a;
    --card: rgba(255,255,255,0.03);
    --accent:#ff6b6b; --muted:#9fb3c8;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family:"Microsoft YaHei","PingFang SC",sans-serif;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#eaf4ff;
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .wrap{
    width:100%; max-width:1200px;
    display:grid; grid-template-columns: 1fr 360px; gap:18px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:18px; border-radius:12px; box-shadow: 0 18px 60px rgba(0,0,0,0.6);
  }
  header{grid-column:1/-1; display:flex; justify-content:space-between; align-items:center}
  h1{margin:0;font-size:1.4rem;color:#fff}
  p.hint{margin:0;color:var(--muted);font-size:0.88rem}

  /* left: wheel */
  .card{background:var(--card); border-radius:10px; padding:14px}
  .wheel-wrap{position:relative; width:680px; max-width:92%; aspect-ratio:1/1; margin:0 auto; border-radius:50%; display:flex; align-items:center; justify-content:center}
  canvas#wheel{width:92%; height:92%; border-radius:50%; background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.02), transparent 18%);}
  
  /* 修改指针样式 - 垂直反转并变细长 */
  .pointer{
    position:absolute; top:-30px; left:50%; transform:translateX(-50%) rotate(180deg); /* 垂直反转 */
    z-index:12; width:0;height:0;
    border-left:12px solid transparent; border-right:12px solid transparent; border-bottom:60px solid var(--accent); /* 变细长 */
    filter: drop-shadow(0 6px 10px rgba(0,0,0,0.4));
    transform-origin: 50% 100%; /* bottom center of the triangular pointer */
    transition: transform 80ms ease-out;
  }
  /* pointer swing class (small rotation left-right) */
  .pointer.swing { animation: pointer-swing 140ms ease-in-out; }
  @keyframes pointer-swing {
    0% { transform: translateX(-50%) rotate(180deg); }
    30% { transform: translateX(-50%) rotate(168deg); }
    70% { transform: translateX(-50%) rotate(188deg); }
    100% { transform: translateX(-50%) rotate(180deg); }
  }

  .controls-row{display:flex; gap:12px; align-items:center; justify-content:center; margin-top:12px}
  .spin-btn{padding:12px 22px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--accent),#ff8a65);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(255,100,100,0.12)}
  .spin-btn:disabled{opacity:0.6;cursor:not-allowed}
  .small{padding:8px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff}
  .result-box{margin-top:10px;text-align:center;font-size:1rem;color:#fff}

  /* right: controls & winners */
  .side{display:flex; flex-direction:column; gap:12px}
  .panel{background:var(--card); padding:12px; border-radius:10px}
  label{color:var(--muted); font-size:0.9rem; display:block; margin-bottom:6px}
  input[type="text"], input[type="number"]{width:100%; padding:8px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff}
  .row{display:flex; gap:8px}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:#42a5f5;color:#fff}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
  .name-list{max-height:220px; overflow:auto; display:flex; flex-direction:column; gap:8px}
  .name-item{display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; background: rgba(255,255,255,0.02); color:#e6eef6}
  .name-item button{background:transparent;border:1px solid rgba(255,255,255,0.06); color:#ff8a80;padding:4px 8px;border-radius:6px;cursor:pointer}

  .chain-box{display:flex; align-items:center; gap:8px; padding:10px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:#fff; font-weight:700; overflow:auto; white-space:nowrap}
  .winners{max-height:260px; overflow:auto; display:flex; flex-direction:column; gap:6px}
  .winner-item{padding:8px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#fff;font-size:0.95rem}

  .footer{color:var(--muted); font-size:0.85rem; text-align:center; margin-top:10px}

  @media(max-width:1024px){ .wrap{grid-template-columns:1fr} .wheel-wrap{width:520px} }
  @media(max-width:768px){ .wheel-wrap{width:380px} }
  @media(max-width:520px){ 
    .wheel-wrap{width:320px} 
    .pointer{border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:40px solid var(--accent)}
    .controls-row{flex-wrap:wrap}
  }
  @media(max-width:400px){ .wheel-wrap{width:280px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>抽奖转盘</h1>
        <p class="hint">----------------</p>
      </div>
      <div style="text-align:right;color:var(--muted)">-------------------</div>
    </header>

    <!-- left: wheel -->
    <div class="card">
      <div class="wheel-wrap">
        <canvas id="wheel" width="1000" height="1000"></canvas>
        <div id="pointer" class="pointer" title="抽奖指针"></div>
      </div>

      <div class="controls-row">
        <button id="spinBtn" class="spin-btn">开始抽奖</button>
        <input id="spinCount" class="small" type="number" min="1" max="50" value="1" title="连抽次数" />
        <input id="spinTime" class="small" type="number" min="2" max="12" value="5" title="旋转时长（秒）" />
        <!-- 音效自动在转盘经过分割点时播放，无单独开关 -->
      </div>

      <div class="result-box">本轮结果： <span id="chainResult">无</span></div>
    </div>

    <!-- right: controls & winners -->
    <div class="side">
      <div class="panel">
        <label>添加名单</label>
        <div class="row">
          <input id="nameAdd" type="text" placeholder="输入姓名并点击添加" />
          <button id="addBtn" class="btn">添加</button>
        </div>
      </div>

      <div class="panel">
        <label>当前名单（可导入 names.json）</label>
        <div class="name-list" id="nameList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="importBtn" class="btn ghost">导入名单</button>
          <input id="fileInput" type="file" accept=".json" style="display:none" />
          <button id="clearNames" class="btn ghost">清空名单</button>
        </div>
      </div>

      <div class="panel">
        <label>抽奖结果（本次）</label>
        <div class="chain-box" id="chainBox">暂无</div>
      </div>

      <div class="panel">
        <label>中奖记录（按时序追加，可重复显示）</label>
        <div class="winners" id="winnerList"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:8px">
          <button id="clearWinners" class="btn ghost">清空记录</button>
        </div>
      </div>

      <div class="panel footer">github.com/Gsjsjzhznsz</div>
    </div>
  </div>

  <!-- 音效：使用国内可访问的链接 -->
  <audio id="tickAudio" preload="auto">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2c9c775f0c.mp3?filename=ui-tap-100687.mp3" type="audio/mpeg">
  </audio>
  <audio id="winAudio" preload="auto">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/19/audio_5c4b7e2e4e.mp3?filename=success-bell-133033.mp3" type="audio/mpeg">
  </audio>

<script>
(() => {
  // DOM
  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const pointer = document.getElementById('pointer');
  const spinBtn = document.getElementById('spinBtn');
  const spinCount = document.getElementById('spinCount');
  const spinTime = document.getElementById('spinTime');

  const nameAdd = document.getElementById('nameAdd');
  const addBtn = document.getElementById('addBtn');
  const importBtn = document.getElementById('importBtn');
  const fileInput = document.getElementById('fileInput');
  const clearNamesBtn = document.getElementById('clearNames');
  const nameListEl = document.getElementById('nameList');

  const chainBox = document.getElementById('chainBox');
  const chainResultSpan = document.getElementById('chainResult');
  const winnerListEl = document.getElementById('winnerList');
  const clearWinnersBtn = document.getElementById('clearWinners');

  const tickAudio = document.getElementById('tickAudio');
  const winAudio = document.getElementById('winAudio');

  // data
  let names = [];
  let winnersHistory = [];
  let animating = false;
  let currentDeg = 0; // rotation degrees (clockwise positive)
  const colors = ['#ff6b6b','#ff8a65','#ffab91','#ffcc80','#fff59d','#c5e1a5','#80deea','#b39ddb','#f48fb1','#a5d6a7','#90caf9','#ffe082'];

  // canvas fit (DPR)
  function fitCanvas(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    drawWheel();
  }
  window.addEventListener('resize', fitCanvas);
  setTimeout(fitCanvas,50);

  function deg2rad(d){ return d * Math.PI / 180; }
  function mod(n,m){ return ((n % m) + m) % m; }
  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  // load names.json if exists
  async function tryLoadNames(){
    try {
      const r = await fetch('names.json', {cache:'no-store'});
      if (!r.ok) throw new Error('no');
      const arr = await r.json();
      if (Array.isArray(arr)) { 
        names = arr.slice(); 
        refreshNameList(); 
        drawWheel(); 
        console.log('names.json loaded'); 
        return; 
      }
    } catch(e){
      // fallback to cache
      const c = localStorage.getItem('lottery_names_cache_v3');
      if (c) {
        try{ 
          names = JSON.parse(c); 
          refreshNameList(); 
          drawWheel(); 
          console.log('loaded cache'); 
          return; 
        } catch(e){}
      }
      console.warn('names.json not loaded (file:// may block). Use 导入名单.');
    }
  }

  // draw wheel; names horizontally displayed
  function drawWheel(){
    const rect = canvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    const cx = w/2, cy = h/2;
    const radius = Math.min(w,h)/2 * 0.92;
    ctx.clearRect(0,0,w,h);

    if (names.length === 0){
      ctx.fillStyle = 'rgba(255,255,255,0.03)';
      ctx.beginPath(); ctx.arc(cx,cy,radius,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#fff'; ctx.font='18px "Microsoft YaHei"'; ctx.textAlign='center'; ctx.fillText('请添加名单或导入 names.json', cx, cy);
      return;
    }

    const n = names.length;
    const anglePer = 360 / n;

    for (let i=0;i<n;i++){
      const start = currentDeg + i * anglePer;
      const startRad = deg2rad(start);
      const endRad = deg2rad(start + anglePer);

      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,radius,startRad,endRad); ctx.closePath();
      ctx.fillStyle = colors[i % colors.length]; ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,0.12)'; ctx.stroke();

      // 修改文本绘制方式 - 水平显示
      const mid = start + anglePer/2;
      const midRad = deg2rad(mid);
      
      // 计算文本位置 - 稍微靠近中心一点
      const tr = radius * 0.62;
      const tx = cx + Math.cos(midRad)*tr;
      const ty = cy + Math.sin(midRad)*tr;
      
      // 计算文本长度和字体大小
      const len = names[i].length || 2;
      const fontSize = Math.max(12, Math.min(18, Math.floor(220 / Math.max(6,len))));
      ctx.font = `${fontSize}px "Microsoft YaHei"`;
      ctx.textAlign = 'center'; 
      ctx.textBaseline = 'middle';
      
      // 保存当前状态
      ctx.save();
      
      // 移动到文本位置
      ctx.translate(tx, ty);
      
      // 旋转文本使其水平显示
      // 计算旋转角度，使文本垂直于半径方向
      let textAngle = midRad + Math.PI;
      
      // 调整角度，使文本更容易阅读
      if (textAngle > Math.PI/2 && textAngle < 3*Math.PI/2) {
        textAngle += Math.PI; // 翻转文本，避免倒置
      }
      
      ctx.rotate(textAngle);
      
      // 绘制文本
      ctx.fillStyle = '#222';
      ctx.fillText(names[i], 0, 0);
      
      // 恢复状态
      ctx.restore();
    }

    // center cap
    ctx.beginPath(); ctx.arc(cx,cy,radius*0.16,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.08)'; ctx.stroke();
  }

  // UI list
  function refreshNameList(){
    nameListEl.innerHTML = '';
    names.forEach((nm, idx) => {
      const div = document.createElement('div'); div.className = 'name-item';
      div.innerHTML = `<span>${idx+1}. ${nm}</span>`;
      const btn = document.createElement('button'); btn.textContent='删除';
      btn.onclick = ()=>{ names.splice(idx,1); saveCache(); refreshNameList(); drawWheel(); };
      div.appendChild(btn);
      nameListEl.appendChild(div);
    });
    saveCache();
  }

  // add handlers
  addBtn.onclick = ()=>{ 
    const v = nameAdd.value.trim(); 
    if(!v) return; 
    names.push(v); 
    nameAdd.value=''; 
    saveCache(); 
    refreshNameList(); 
    drawWheel(); 
  };
  
  nameAdd.addEventListener('keydown', (e)=>{ 
    if (e.key === 'Enter') addBtn.click(); 
  });

  importBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', (ev)=>{
    const f = ev.target.files && ev.target.files[0]; 
    if (!f) return;
    
    const reader = new FileReader();
    reader.onload = ()=> {
      try {
        const arr = JSON.parse(reader.result);
        if (!Array.isArray(arr)) throw new Error('JSON 必须为数组');
        names = arr.slice(); 
        saveCache(); 
        refreshNameList(); 
        drawWheel(); 
        alert('已导入 ' + names.length + ' 条名单');
      } catch(e){ alert('导入失败：' + e.message); }
    };
    reader.readAsText(f,'utf-8'); 
    fileInput.value = '';
  });

  clearNamesBtn.addEventListener('click', ()=>{ 
    if (!confirm('清空全部姓名？')) return; 
    names=[]; 
    saveCache(); 
    refreshNameList(); 
    drawWheel(); 
  });

  // winners UI
  function pushWinner(name){
    winnersHistory.unshift({name, time: new Date().toLocaleString()});
    const li = document.createElement('div'); 
    li.className='winner-item'; 
    li.textContent = `${name}  ·  ${new Date().toLocaleTimeString()}`;
    winnerListEl.insertBefore(li, winnerListEl.firstChild);
    
    // Limit history to 200 items
    while (winnerListEl.children.length > 200) {
      winnerListEl.removeChild(winnerListEl.lastChild);
    }
  }
  
  clearWinnersBtn.addEventListener('click', ()=>{ 
    if (!confirm('清空中奖记录？')) return; 
    winnersHistory=[]; 
    winnerListEl.innerHTML=''; 
  });

  // pointer swing trigger
  function triggerPointerSwing(){
    // add class to animate; remove after animation end
    pointer.classList.remove('swing');
    // force reflow to restart animation
    void pointer.offsetWidth;
    pointer.classList.add('swing');
    // play tick
    try{ 
      tickAudio.currentTime = 0; 
      tickAudio.play().catch(e => console.log("音频播放失败:", e)); 
    } catch(e){}
  }

  // animate rotation with sector-cross detection to trigger pointer swing
  function animateToIndex(index, durationSec){
    return new Promise((resolve) => {
      if (animating) return resolve();
      animating = true;
      const n = names.length;
      const anglePer = 360 / n;
      const midDeg = index * anglePer + anglePer/2;
      const pointerDeg = -90;
      
      // compute base delta: make sector mid align with pointer (+ small random within sector)
      const baseDelta = mod(pointerDeg - (currentDeg + midDeg), 360);
      const extraSpins = randInt(3,7);
      
      // random offset within sector so results look less mechanical
      const offset = (Math.random() - 0.5) * (anglePer * 0.6);
      const delta = baseDelta + extraSpins*360 + offset;
      const startDeg = currentDeg;
      const endDeg = currentDeg + delta;
      const startTime = performance.now();

      // we will detect sector boundary crossings by tracking the instantaneous sector at pointer each frame
      const totalBoundariesToCross = Math.floor((endDeg - startDeg) / anglePer);
      let lastBoundaryCount = Math.floor((startDeg) / anglePer);

      // start animation
      function frame(now){
        const t = Math.min((now - startTime) / (durationSec*1000), 1);
        // easeInOutCubic
        const eased = t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
        currentDeg = startDeg + (endDeg - startDeg) * eased;
        drawWheel();
        
        // compute how many boundaries passed (using floor of rotation/anglePer)
        const boundaryCount = Math.floor(currentDeg / anglePer);
        if (boundaryCount !== lastBoundaryCount){
          // crossed one or more boundaries — for each change, trigger pointer swing
          triggerPointerSwing();
          lastBoundaryCount = boundaryCount;
        }
        
        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          // finish
          currentDeg = mod(endDeg, 360);
          drawWheel();
          
          // final winner sound
          try{ 
            winAudio.currentTime = 0; 
            winAudio.play().catch(e => console.log("中奖音效播放失败:", e)); 
          } catch(e){}
          
          animating = false;
          resolve();
        }
      }
      requestAnimationFrame(frame);
    });
  }

  // Do one draw: choose random index, animate, record winner (names not removed)
  async function drawOnce(durationSec){
    if (names.length === 0) { 
      alert('名单为空'); 
      return null; 
    }
    const idx = Math.floor(Math.random() * names.length);
    const winner = names[idx];
    await animateToIndex(idx, durationSec);
    // record
    pushWinner(winner);
    return winner;
  }

  // chain draws sequentially, show chain in single-line box with arrows
  async function runChain(){
    if (animating) return;
    if (names.length === 0) { 
      alert('名单为空'); 
      return; 
    }
    
    const count = Math.max(1, Math.min(50, parseInt(spinCount.value) || 1));
    const duration = Math.max(2, Math.min(12, parseFloat(spinTime.value) || 5));
    
    spinBtn.disabled = true; 
    addBtn.disabled = true; 
    importBtn.disabled = true;
    
    const chain = [];
    for (let i=0;i<count;i++){
      const winner = await drawOnce(duration);
      if (winner) chain.push(winner);
      await new Promise(r=>setTimeout(r, 600));
    }
    
    chainBox.textContent = chain.length ? chain.join(' → ') : '无';
    chainResultSpan.textContent = chain.length ? chain.join(' → ') : '无';
    
    spinBtn.disabled = false; 
    addBtn.disabled = false; 
    importBtn.disabled = false;
  }

  // cache functions
  function saveCache(){ 
    try{ 
      localStorage.setItem('lottery_names_cache_v3', JSON.stringify(names)); 
    } catch(e){} 
  }

  // bind spin button
  spinBtn.addEventListener('click', runChain);

  // init
  tryLoadNames();
  setTimeout(()=>{ drawWheel(); }, 120);

  // expose some utilities for debugging
  window._spin = { names, runChain, drawOnce };

})();
</script>
</body>
</html>